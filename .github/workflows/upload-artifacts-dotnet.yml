name: Upload artifacts (.NET)

on:
  workflow_call:
    inputs:
      runs-on:
        description: ランナー環境。
        required: false
        type: string
        default: ubuntu-latest
      project:
        description: プロジェクト名。
        required: true
        type: string
      target-platform-identifier:
        description: プラットフォーム識別子。
        required: false
        type: string
        default: none
      target-platform-version:
        description: プラットフォームバージョンを表す文字列。
        required: false
        type: string
        default: null
      os:
        description: OSの名前。（ランタイム識別子）
        required: true
        type: string
      architecture:
        description: アーキテクチャ名。（ランタイム識別子）
        required: true
        type: string
      workload-restore:
        description: dotnet workload restoreを実行するかどうか。
        required: false
        type: boolean
        default: false
      version:
        description: バージョンを表す文字列。
        required: true
        type: string
      suffix:
        description: アップロードする成果物名の末尾に追加する文字列。
        required: false
        type: string
        default: null

permissions: {}

env:
  OUTPUT_DIRECTORY: publish
  OUTPUT_FILE_NAME: ${{ inputs.suffix != '' && format('{0}_{1}', inputs.project, inputs.suffix) || inputs.project }}
  RETENTION_DAYS: 1

jobs:
  main:
    name: >-
      ${{ inputs.project }} -
      ${{ (startsWith(inputs.os, 'win') && 'windows') || (startsWith(inputs.os, 'osx') && 'macos') || 'linux' }}(${{ inputs.architecture }})
    runs-on: ${{ inputs.runs-on }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: .NET Publish
        uses: finphie/Actions/.github/actions/dotnet-publish@main
        with:
          project: ${{ inputs.project }}
          version: ${{ inputs.version }}
          target-platform-identifier: ${{ inputs.target-platform-identifier }}
          target-platform-version: ${{ inputs.target-platform-version }}
          runtime: ${{ inputs.os }}-${{ inputs.architecture }}
          workload-restore: ${{ inputs.workload-restore }}
          output-directory: ${{ env.OUTPUT_DIRECTORY }}

      - name: Compress archive
        uses: finphie/Actions/.github/actions/compress-archive@main
        with:
          path: ${{ env.OUTPUT_DIRECTORY }}
          destination-path: ${{ runner.temp }}/${{ env.OUTPUT_FILE_NAME }}.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.OUTPUT_FILE_NAME }}
          path: ${{ runner.temp }}/${{ env.OUTPUT_FILE_NAME }}.zip
          retention-days: ${{ env.RETENTION_DAYS }}
